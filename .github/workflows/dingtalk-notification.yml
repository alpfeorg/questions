name: DingTalk Notification

on:
  push:
    branches:
      - main

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Get commit info
        id: commit
        uses: actions/github-script@v6
        with:
          script: |
            const commit = context.payload.head_commit;
            const author = commit.author.name;
            const repo = context.repo.repo;
            return { author, repo };

      - name: Send DingTalk notification
        run: |
          # 生成时间戳
          TIMESTAMP=$(date +%s)

          # 生成签名
          STRING_TO_SIGN="$TIMESTAMP\n${{ secrets.DINGTALK_SECRET }}"
          SIGN=$(echo -e "$STRING_TO_SIGN" | openssl dgst -sha256 -hmac "${{ secrets.DINGTALK_SECRET }}" | awk '{print $2}')

          # 准备消息内容
          MESSAGE="【${{ steps.commit.outputs.author }}】在【${{ steps.commit.outputs.repo }}】仓库里提交了，大家快去看呀"

          # 发送请求
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Content-Type: application/json" \
            -H "timestamp: $TIMESTAMP" \
            -H "sign: $SIGN" \
            -d "{
              \"msgtype\": \"text\",
              \"text\": {
                \"content\": \"$MESSAGE\"
              }
            }" \
            "${{ secrets.DINGTALK_TOKEN }}")

          # 获取响应状态码
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          RESPONSE_BODY=$(echo "$RESPONSE" | sed '$d')

          # 输出调试信息
          echo "Timestamp: $TIMESTAMP"
          echo "Sign: $SIGN"
          echo "Response Code: $HTTP_CODE"
          echo "Response Body: $RESPONSE_BODY"

          # 检查响应
          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "Failed to send notification. HTTP Code: $HTTP_CODE"
            exit 1
          fi
