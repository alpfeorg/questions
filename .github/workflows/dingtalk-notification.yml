name: DingTalk Notification

on:
  push:
    branches:
      - main

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Get commit info
        id: commit
        uses: actions/github-script@v6
        with:
          script: |
            const commit = context.payload.head_commit;
            const author = commit.author.name;
            const repo = context.repo.repo;
            return { author, repo };

      - name: Send DingTalk notification
        run: |
          TIMESTAMP=$(date +%s)
          STRING_TO_SIGN="$TIMESTAMP\n${{ secrets.DINGTALK_SECRET }}"
          SIGN=$(echo -e "$STRING_TO_SIGN" | openssl dgst -sha256 -hmac "${{ secrets.DINGTALK_SECRET }}" | awk '{print $2}')

          curl -X POST \
            -H "Content-Type: application/json" \
            -H "timestamp: $TIMESTAMP" \
            -H "sign: $SIGN" \
            -d "{
              \"msgtype\": \"text\",
              \"text\": {
                \"content\": \"【${{ steps.commit.outputs.author }}】在【${{ steps.commit.outputs.repo }}】仓库里提交了，大家快去看呀\"
              }
            }" \
            "${{ secrets.DINGTALK_TOKEN }}"
